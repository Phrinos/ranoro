
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Default to denying all access to prevent unauthorized reads/writes.
    match /{document=**} {
      allow read, write: if false;
    }

    // Allow authenticated users to read and write the main database document
    // which contains all the private workshop data.
    match /database/{docId} {
      allow read, write: if request.auth != null;
    }

    // --- Public Collections ---

    // Allow anyone to read a public quote document.
    // Only authenticated users (employees) can create or update them.
    match /publicQuotes/{quoteId} {
      allow read: if true;
      allow write: if request.auth != null;
    }

    // Allow anyone to read a public service sheet.
    // Allow authenticated users to create them.
    match /publicServices/{serviceId} {
      allow read: if true;
      allow create: if request.auth != null;

      // Allow updates only under specific conditions:
      // 1. If the user is authenticated (an employee), they can update anything.
      // 2. If the user is NOT authenticated (a customer), they can ONLY update
      //    the signature fields. This is crucial for the public signing feature.
      allow update: if request.auth != null ||
        (request.resource.data.diff(resource.data).affectedKeys()
          .hasOnly(['customerSignatureReception', 'receptionSignatureViewed', 'customerSignatureDelivery', 'deliverySignatureViewed']));
    }
  }
}
