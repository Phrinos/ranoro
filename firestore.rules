rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- REGLAS POR DEFECTO ---
    // Denegar lectura y escritura a cualquier ruta no definida explícitamente.
    match /{document=**} {
      allow read, write: if false;
    }

    // --- REGLAS DE ACCESO PÚBLICO ---
    // Cualquiera puede LEER un documento de servicio público si conoce el enlace.
    // Nadie, excepto el sistema (a través de funciones de backend seguras, no el cliente), puede escribir aquí.
    match /publicServices/{publicId} {
      allow read: if true;
      allow write: if false; // La escritura debe ser desde un backend de confianza
    }
    
    // --- REGLAS PARA USUARIOS AUTENTICADOS ---

    // Los usuarios pueden leer perfiles de otros, pero solo escribir en el suyo.
    match /users/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // Cualquier usuario autenticado puede leer y escribir en estas colecciones.
    // Esto es permisivo para la etapa de desarrollo; se puede restringir más adelante
    // (ej. solo los administradores pueden crear nuevos técnicos).
    match /serviceRecords/{serviceId} { allow read, write: if request.auth != null; }
    match /vehicles/{vehicleId} { allow read, write: if request.auth != null; }
    match /technicians/{technicianId} { allow read, write: if request.auth != null; }
    match /administrativeStaff/{staffId} { allow read, write: if request.auth != null; }
    match /inventory/{itemId} { allow read, write: if request.auth != null; }
    match /sales/{saleId} { allow read, write: if request.auth != null; }
    match /appRoles/{roleId} { allow read, write: if request.auth != null; }
    match /inventoryCategories/{categoryId} { allow read, write: if request.auth != null; }
    match /suppliers/{supplierId} { allow read, write: if request.auth != null; }
    match /serviceTypes/{typeId} { allow read, write: if request.auth != null; }
    match /auditLogs/{logId} { allow read, write: if request.auth != null; }
    match /vehiclePriceLists/{listId} { allow read, write: if request.auth != null; }
    match /drivers/{driverId} { allow read, write: if request.auth != null; }
    match /rentalPayments/{paymentId} { allow read, write: if request.auth != null; }
    match /vehicleExpenses/{expenseId} { allow read, write: if request.auth != null; }
    match /ownerWithdrawals/{withdrawalId} { allow read, write: if request.auth != null; }
    match /fixedExpenses/{expenseId} { allow read, write: if request.auth != null; }
    match /cashDrawerTransactions/{transactionId} { allow read, write: if request.auth != null; }
    match /initialCashBalance/{balanceId} { allow read, write: if request.auth != null; }
    match /publicOwnerReports/{reportId} { allow read, write: if request.auth != null; }

  }
}
