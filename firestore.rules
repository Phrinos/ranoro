rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // The main database document containing all app state.
    // Only authenticated users can read and write to it.
    match /database/main {
      allow read, write: if request.auth != null;
    }

    // Public quotes collection. Anyone can read. No one can write.
    match /publicQuotes/{quoteId} {
      allow get: if true;
      allow list, create, update, delete: if false;
    }

    // Public services collection.
    match /publicServices/{serviceId} {
      // Anyone can read the public service document.
      allow get: if true;

      // Anyone can update ONLY the signature fields.
      // This is crucial for the public signing feature to work.
      allow update: if request.resource.data.diff(resource.data).affectedKeys()
                      .hasOnly(['customerSignatureReception', 'receptionSignatureViewed', 'customerSignatureDelivery', 'deliverySignatureViewed']);
      
      // No one can list, create, or delete public documents directly from the client.
      allow list, create, delete: if false;
    }

    // Default deny for all other collections/documents.
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
