
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // Private database document containing all app data
    match /database/main {
      allow read, write: if request.auth != null;
    }

    // Publicly accessible quotes collection
    match /publicQuotes/{quoteId} {
      // Anyone can read a public quote if they have the link
      allow get: if true;
      
      // Allow authenticated users (staff) to create or update the public doc
      allow create, update: if request.auth != null;
      
      // Deny listing or deleting from the client
      allow list, delete: if false;
    }
    
    // Publicly accessible service sheets collection
    match /publicServices/{serviceId} {
      // Anyone with the link can read the service sheet
      allow get: if true;
      
      // Authenticated users (staff) can create or update the service sheet
      allow create, update: if request.auth != null;
                      
      // Unauthenticated users (customers) can ONLY update the signature fields.
      // This rule is OR'd with the one above, allowing this specific public action.
      allow update: if request.auth == null && 
                      request.resource.data.diff(resource.data).affectedKeys()
                      .hasOnly(['customerSignatureReception', 'receptionSignatureViewed', 'customerSignatureDelivery', 'deliverySignatureViewed']);
                      
      // Deny listing or deleting from the client
      allow list, delete: if false;
    }
    
    // By default, deny access to any other collections/documents
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
