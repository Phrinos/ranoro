rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    /* ───────────────────────────────────────────────
       0) DENEGAR TODO POR DEFECTO
       ─────────────────────────────────────────────── */
    match /{document=**} {
      allow read, write: if false;
    }

    /* ───────────────────────────────────────────────
       1) BASE DE DATOS PRINCIPAL DEL TALLER
          (/database/main  y cualquier otro doc en /database)
       ─────────────────────────────────────────────── */
    match /database/{docId} {
      allow read, write: if request.auth != null;
    }

    /* ───────────────────────────────────────────────
       2) COTIZACIONES PÚBLICAS
          (/publicQuotes/{quoteId})
       ─────────────────────────────────────────────── */
    match /publicQuotes/{quoteId} {
      // Lectura libre (enlace compartido)
      allow read: if true;

      // Creación / edición / eliminación solo usuarios autenticados
      allow write: if request.auth != null;
    }

    /* ───────────────────────────────────────────────
       3) HOJAS DE SERVICIO PÚBLICAS
          (/publicServices/{serviceId})
       ─────────────────────────────────────────────── */
    match /publicServices/{serviceId} {
      // Cualquiera puede leer si conoce el enlace
      allow read: if true;

      // Crear o eliminar: requiere autenticación
      allow create, delete: if request.auth != null;

      /*  Actualizar:
          - Permitido para usuarios autenticados.
          - Permitido a usuarios NO autenticados **solo** si
            los únicos campos cambiados son las firmas del cliente
            (útil cuando el cliente firma en el mismo enlace público).
      */
      allow update: if request.auth != null ||
        (request.auth == null &&
         request.resource.data
           .diff(resource.data)
           .affectedKeys()
           .hasOnly([
             'customerSignatureReception',
             'receptionSignatureViewed',
             'customerSignatureDelivery',
             'deliverySignatureViewed'
           ]));
    }
  }
}
