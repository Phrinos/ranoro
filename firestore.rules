rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    /*───────────────────────────────
      FUNCIONES DE UTILIDAD
    ───────────────────────────────*/
    function isAuthed()         { return request.auth != null; }
    function isOwner(userId)    { return isAuthed() && request.auth.uid == userId; }

    /*───────────────────────────────
      RUTAS 100 % PÚBLICAS (solo lectura)
    ───────────────────────────────*/
    match /publicServices/{publicId} {
      allow read: if true;

      // Permitir que el cliente sin sesión actualice SOLO las firmas
      allow update: if isAuthed() ||
        request.resource.data.diff(resource.data).affectedKeys()
          .hasOnly([
            'customerSignatureReception',
            'customerSignatureDelivery',
            'receptionSignatureViewed',
            'deliverySignatureViewed'
          ]);

      // Crear / borrar solo desde backend o usuario autenticado
      allow create, delete: if isAuthed();
    }

    match /publicOwnerReports/{reportId}   { allow read: if true; }
    match /public_documents/{docId}        { allow read: if true; }

    /*───────────────────────────────
      PERFIL DE USUARIOS
    ───────────────────────────────*/
    match /users/{userId} {
      allow read:  if isAuthed();
      allow write: if isOwner(userId);
    }

    /*───────────────────────────────
      COLECCIONES DE NEGOCIO
      (requieren sesión cualquiera)
    ───────────────────────────────*/
    match /serviceRecords/{serviceId} {
      allow read, write: if isAuthed();

      // ejemplo de sub-colección protegida
      match /notes/{noteId} {
        allow read, write: if isAuthed();
      }
    }

    match /vehicles/{vehicleId}                    { allow read, write: if isAuthed(); }
    match /technicians/{techId}                    { allow read, write: if isAuthed(); }
    match /administrativeStaff/{staffId}           { allow read, write: if isAuthed(); }
    match /inventory/{itemId}                      { allow read, write: if isAuthed(); }
    match /sales/{saleId}                          { allow read, write: if isAuthed(); }
    match /appRoles/{roleId}                       { allow read, write: if isAuthed(); }
    match /inventoryCategories/{catId}             { allow read, write: if isAuthed(); }
    match /suppliers/{supId}                       { allow read, write: if isAuthed(); }
    match /serviceTypes/{typeId}                   { allow read, write: if isAuthed(); }
    match /auditLogs/{logId}                       { allow read, write: if isAuthed(); }
    match /vehiclePriceLists/{listId}              { allow read, write: if isAuthed(); }
    match /drivers/{driverId}                      { allow read, write: if isAuthed(); }
    match /rentalPayments/{paymentId}              { allow read, write: if isAuthed(); }
    match /vehicleExpenses/{expenseId}             { allow read, write: if isAuthed(); }
    match /ownerWithdrawals/{withdrawalId}         { allow read, write: if isAuthed(); }
    match /fixedExpenses/{expenseId}               { allow read, write: if isAuthed(); }
    match /cashDrawerTransactions/{transactionId}  { allow read, write: if isAuthed(); }
    match /initialCashBalance/{balanceId}          { allow read, write: if isAuthed(); }

    /*───────────────────────────────
      DOCUMENTO PRINCIPAL DEL SISTEMA
      (si tu app lo usa)
    ───────────────────────────────*/
    match /database/main {
      allow read, write: if isAuthed();   // ajusta si solo quieres lectura
    }

    /*───────────────────────────────
      CATCH-ALL FINAL → DENY
    ───────────────────────────────*/
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
