rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Regla general: Solo usuarios autenticados pueden leer/escribir.
    match /{document=**} {
      allow read, write: if request.auth != null;
    }

    // Excepción: Permite que cualquiera (incluso no autenticado)
    // actualice *únicamente* los campos de firma en la colección pública.
    match /publicServices/{serviceId} {
      // La lectura pública ya está cubierta por la regla de storage.
      // Permitimos la escritura bajo condiciones muy específicas.
      allow write: if request.resource.data.diff(resource.data).affectedKeys().hasOnly([
        'customerSignatureReception', 
        'customerSignatureDelivery',
        'receptionSignatureViewed',
        'deliverySignatureViewed'
      ]);
    }
  }
}
