rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
  
    // Main private database document
    // Only authenticated users can read/write
    match /database/main {
      allow read, write: if request.auth != null;
    }

    // Public quotes are read-only for everyone, writable by authenticated users
    match /publicQuotes/{quoteId} {
      allow read: if true;
      allow write: if request.auth != null;
    }
    
    // Public owner reports are read-only for everyone, writable by authenticated users
    match /publicOwnerReports/{reportId} {
      allow read: if true;
      allow write: if request.auth != null;
    }

    // Public services can be read by anyone,
    // written to by authenticated users,
    // and partially updated (signatures) by unauthenticated users (customers)
    match /publicServices/{serviceId} {
      allow read: if true;
      
      // Authenticated users (employees) can do anything
      allow write: if request.auth != null;
      
      // Customers (unauthenticated) can only update signature-related fields
      allow update: if request.auth == null &&
                     request.resource.data.diff(resource.data).affectedKeys()
                       .hasAny(['customerSignatureReception', 'customerSignatureDelivery', 'receptionSignatureViewed', 'deliverySignatureViewed']) &&
                     request.resource.data.diff(resource.data).affectedKeys()
                       .difference(['customerSignatureReception', 'customerSignatureDelivery', 'receptionSignatureViewed', 'deliverySignatureViewed']).size() == 0;
    }
  }
}
