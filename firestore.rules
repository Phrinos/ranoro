rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Default to secure: no one can access anything unless explicitly allowed.
    match /{document=**} {
      allow read, write: if false;
    }

    // Main database document for the workshop.
    // Only authenticated users of the app can read or write.
    match /database/main {
      allow read, write: if request.auth != null;
    }
    
    // Publicly readable collection for quotes.
    // No one can write to them from the client side.
    match /publicQuotes/{quoteId} {
      allow read: if true;
      allow write: if false; 
    }
    
    // Publicly readable collection for service sheets.
    match /publicServices/{serviceId} {
      // Anyone can read a public service sheet.
      allow read: if true;
      
      // Allow anyone (including unauthenticated customers) to update ONLY the signature fields.
      // This is crucial for the public signing feature.
      // This rule is designed to work with the `saveSignature` server action.
      allow update: if request.writeFields.hasOnly([
            'customerSignatureReception', 
            'receptionSignatureViewed',
            'customerSignatureDelivery',
            'deliverySignatureViewed'
           ]);
                   
      // Deny creates and deletes from the client.
      allow create, delete: if false;
    }
  }
}
